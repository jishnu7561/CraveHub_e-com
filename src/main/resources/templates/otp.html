<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Verification Form</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include Bootstrap JS and Popper.js (for Bootstrap's JavaScript functionality) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-pzjw2f5M3h8HtAq9OjllFpWyb+st9R6lCvq/rVm2p+pOA+M/zDd5PpaT+pDK9Usl" crossorigin="anonymous">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <!-- Your custom CSS -->
    <link rel="stylesheet" href="/css/otp.css">

</head>
<body class="container-fluid h-100 bg-body-tertiary  d-block">
<div class="row justify-content-center align-items-center d-flex otp-box">
    <div class="col-12 col-md-6 col-lg-4" style="min-width: 500px;">
        <div class="card bg-white mb-5 mt-5 border-0" style="box-shadow: 0 12px 15px rgba(0, 0, 0, 0.02);">
            <div class="card-body p-5 text-center shadow">
                <h4>Verify</h4>
                <p>Your code was sent to you via email <br>Check your email at <b><span id="maskedEmail"></span></b> for the OTP:</p>
                <p></p>

<!--                <form th:action="@{'/verify-account?email=' + ${email}}" method="post"  th:object="${otp}">-->
                <form th:action="@{/verify-account}" method="post"  th:object="${otp}">
                <div class="otp-field mb-4">
                        <input name="a" type="number" />
                        <input name="b" type="number" disabled />
                        <input name="c" type="number" disabled />
                        <input name="d" type="number" disabled />
                        <input name="e" type="number" disabled />
                        <input name="f" type="number" disabled />
                    </div>
                    <button type="submit" class="btn btn-warning mb-3">
                        Verify
                    </button>
                </form>
                <form th:action="@{/regenerate-otp}" method="post">
                    <input type="hidden" name="email" th:value="${email}" />
                    <button type="submit" class="btn btn-primary" onclick="regenerateOtp()">Regenerate OTP</button>
                </form>
                <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>
                <p>Time left: <span class="text-danger" id="timer">01:00</span></p>
                <!-- <p class="resend text-muted mb-0">
                  Didn't receive code? <a href="">Request again</a>
                </p> -->
            </div>

        </div>
    </div>
</div>


<!--------------------------------------------------success message---------------------------------------------------------->

<div th:if="${param.error}">
    <div id="myAlert" class="alert  alert-warning fade show fixed-top d-flex justify-content-between" data-aos="fade-down"  role="alert" >
        <p class="text-danger"><strong class="fs-2 ">Wrong!!!!</strong>, the Otp you entered is a wrong one!</p>
        <button type="button" class="btn-close " data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
<script>
    AOS.init();
</script>

<!--------------------------------------------------success message---------------------------------------------------------->

<script>
    const inputs = document.querySelectorAll(".otp-field > input");
const button = document.querySelector(".btn");

window.addEventListener("load", () => inputs[0].focus());
button.setAttribute("disabled", "disabled");

inputs[0].addEventListener("paste", function (event) {
  event.preventDefault();

  const pastedValue = (event.clipboardData || window.clipboardData).getData(
    "text"
  );
  const otpLength = inputs.length;

  for (let i = 0; i < otpLength; i++) {
    if (i < pastedValue.length) {
      inputs[i].value = pastedValue[i];
      inputs[i].removeAttribute("disabled");
      inputs[i].focus;
    } else {
      inputs[i].value = ""; // Clear any remaining inputs
      inputs[i].focus;
    }
  }
});

inputs.forEach((input, index1) => {
  input.addEventListener("keyup", (e) => {
    const currentInput = input;
    const nextInput = input.nextElementSibling;
    const prevInput = input.previousElementSibling;

    if (currentInput.value.length > 1) {
      currentInput.value = "";
      return;
    }

    if (
      nextInput &&
      nextInput.hasAttribute("disabled") &&
      currentInput.value !== ""
    ) {
      nextInput.removeAttribute("disabled");
      nextInput.focus();
    }

    if (e.key === "Backspace") {
      inputs.forEach((input, index2) => {
        if (index1 <= index2 && prevInput) {
          input.setAttribute("disabled", true);
          input.value = "";
          prevInput.focus();
        }
      });
    }

    button.classList.remove("active");
    button.setAttribute("disabled", "disabled");

    const inputsNo = inputs.length;
    if (!inputs[inputsNo - 1].disabled && inputs[inputsNo - 1].value !== "") {
      button.classList.add("active");
      button.removeAttribute("disabled");

      return;
    }
  });
});

// otp timer

function startCountdown(durationInSeconds) {
	const timerElement = document.getElementById("timer");
	let timeLeft = durationInSeconds;

	const countdownInterval = setInterval(function() {
		const minutes = Math.floor(timeLeft / 60);
		const seconds = timeLeft % 60;

		const minutesStr = String(minutes).padStart(2, '0');
		const secondsStr = String(seconds).padStart(2, '0');

		timerElement.textContent = `${minutesStr}:${secondsStr}`;

		if (timeLeft <= 0) {
			clearInterval(countdownInterval);
			timerElement.textContent = "00:00";
			timerElement.textContent="The OTP has expired"
		} else {
			timeLeft--;
		}
	}, 1000);
}

startCountdown(120);
</script>
<script>
    function regenerateOtp() {
        document.getElementById('regenerateOtpForm').target = 'hiddenFrame';
        document.getElementById('regenerateOtpForm').submit();
    }

    // Function to handle response from server
    function handleResponse(response) {
        document.getElementById('response').innerHTML = response;
    }
</script>
</body>
</html>